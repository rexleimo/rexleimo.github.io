<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Build Your Own Mini Actor Framework: Run Concurrency Like a Coffee Shop | Ê¢¶ÂÖΩÁºñÁ®ã</title><meta name=keywords content="Rust Actor framework,Tokio mpsc,supervisor,oneshot,registry,async Rust,message passing,concurrency model"><meta name=description content="A hands-on guide to building a usable mini Actor framework in Rust from scratch: Actor, Addr, spawn, supervise, a simple registry, message passing, and HTTP interaction."><meta name=author content="Rexai Programming"><link rel=canonical href=https://rexai.top/en/tutorials/rust/mini-actor-framework-rust/><link crossorigin=anonymous href=/assets/css/stylesheet.36a35dd316f612e0d26c90cd90313d15705d24943d7cf2559674e92b21704616.css integrity="sha256-NqNd0xb2EuDSbJDNkDE9FXBdJJQ9fPJVlnTpKyFwRhY=" rel="preload stylesheet" as=style><link rel=icon href=https://rexai.top/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://rexai.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://rexai.top/favicon-32x32.png><link rel=apple-touch-icon href=https://rexai.top/apple-touch-icon.png><link rel=mask-icon href=https://rexai.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://rexai.top/tutorials/rust/mini-actor-framework-rust/><link rel=alternate hreflang=en href=https://rexai.top/en/tutorials/rust/mini-actor-framework-rust/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=/css/extended/modern-typography.min.css integrity><style>.promotion-section{margin-top:3rem;padding:2rem;text-align:center;background:linear-gradient(135deg,rgba(59,130,246,5%) 0%,rgba(139,92,246,5%) 100%);border-radius:16px;border:1px solid rgba(59,130,246,.1);position:relative;overflow:hidden}.promotion-section::before{content:"";position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#3b82f6,#8b5cf6,#06b6d4);border-radius:16px 16px 0 0}.promotion-section h3{margin-bottom:1.5rem;color:var(--primary);font-size:1.5rem;font-weight:600;background:linear-gradient(135deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.qr-codes{display:flex;gap:2.5rem;justify-content:center;flex-wrap:wrap;margin-top:2rem}.qr-item{text-align:center;position:relative;transition:transform .3s ease}.qr-item:hover{transform:translateY(-5px)}.qr-item img{width:160px;height:160px;border:2px solid #e5e7eb;border-radius:16px;padding:12px;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,8%),0 1px 3px rgba(0,0,0,.1);transition:all .3s ease;position:relative;overflow:hidden}.qr-item img::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(139,92,246,.1));opacity:0;transition:opacity .3s ease;z-index:1}.qr-item:hover img{border-color:#3b82f6;box-shadow:0 8px 30px rgba(59,130,246,.2),0 2px 8px rgba(0,0,0,.1);transform:scale(1.02)}.qr-item:hover img::before{opacity:1}.qr-item p{margin-top:1rem;font-size:1rem;color:var(--secondary);font-weight:500;position:relative}.modern-button{display:inline-flex;align-items:center;padding:.75rem 1.5rem;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:#fff;text-decoration:none;border-radius:12px;font-weight:500;transition:all .3s ease;box-shadow:0 4px 12px rgba(59,130,246,.3);position:relative;overflow:hidden}.modern-button::before{content:"";position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .6s ease}.modern-button:hover::before{left:100%}.modern-button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,.4)}@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}.post-content>*{animation:fadeInUp .6s ease-out;animation-fill-mode:both}.post-content>*:nth-child(1){animation-delay:.1s}.post-content>*:nth-child(2){animation-delay:.2s}.post-content>*:nth-child(3){animation-delay:.3s}.post-content>*:nth-child(4){animation-delay:.4s}@media(max-width:768px){.promotion-section{margin:2rem -1rem;border-radius:0;padding:1.5rem 1rem}.qr-codes{flex-direction:column;align-items:center;gap:1.5rem}.qr-item img{width:140px;height:140px;padding:10px}.promotion-section h3{font-size:1.25rem}}.reading-progress{position:fixed;top:0;left:0;width:0%;height:3px;background:linear-gradient(90deg,#3b82f6,#8b5cf6,#06b6d4);z-index:999;transition:width .1s ease}.post-actions{margin-top:2.5rem;padding-top:1.25rem;border-top:1px dashed var(--border)}.post-actions__group{display:flex;flex-wrap:wrap;gap:.75rem 1rem;align-items:center}.post-actions__item{display:inline-flex;align-items:center}*{transition:background-color .3s ease,color .3s ease,border-color .3s ease}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--theme)}::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,#2563eb,#7c3aed)}</style><script>document.addEventListener("DOMContentLoaded",function(){const e=document.createElement("div");e.className="reading-progress",document.body.appendChild(e);function t(){const t=document.documentElement.scrollTop||document.body.scrollTop,n=document.documentElement.scrollHeight-document.documentElement.clientHeight,s=t/n*100;e.style.width=s+"%"}window.addEventListener("scroll",t),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=document.querySelector(this.getAttribute("href"));t&&t.scrollIntoView({behavior:"smooth",block:"start"})})})})</script><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-K6VQRF8T")</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K6VQRF8T" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-62VF26DEY6"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-62VF26DEY6")</script><meta property="og:url" content="https://rexai.top/en/tutorials/rust/mini-actor-framework-rust/"><meta property="og:site_name" content="Ê¢¶ÂÖΩÁºñÁ®ã"><meta property="og:title" content="Build Your Own Mini Actor Framework: Run Concurrency Like a Coffee Shop"><meta property="og:description" content="A hands-on guide to building a usable mini Actor framework in Rust from scratch: Actor, Addr, spawn, supervise, a simple registry, message passing, and HTTP interaction."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="tutorials"><meta property="article:published_time" content="2025-08-21T00:00:00+08:00"><meta property="article:modified_time" content="2025-08-21T00:00:00+08:00"><meta property="article:tag" content="Rust"><meta property="article:tag" content="Concurrency"><meta property="article:tag" content="Async"><meta property="article:tag" content="Tokio"><meta property="article:tag" content="Actor"><meta property="og:image" content="https://rexai.top/en/tutorials/rust/mini-actor-framework-rust/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rexai.top/en/tutorials/rust/mini-actor-framework-rust/cover.png"><meta name=twitter:title content="Build Your Own Mini Actor Framework: Run Concurrency Like a Coffee Shop"><meta name=twitter:description content="A hands-on guide to building a usable mini Actor framework in Rust from scratch: Actor, Addr, spawn, supervise, a simple registry, message passing, and HTTP interaction."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Tutorials","item":"https://rexai.top/en/tutorials/"},{"@type":"ListItem","position":2,"name":"Build Your Own Mini Actor Framework: Run Concurrency Like a Coffee Shop","item":"https://rexai.top/en/tutorials/rust/mini-actor-framework-rust/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Build Your Own Mini Actor Framework: Run Concurrency Like a Coffee Shop","name":"Build Your Own Mini Actor Framework: Run Concurrency Like a Coffee Shop","description":"A hands-on guide to building a usable mini Actor framework in Rust from scratch: Actor, Addr, spawn, supervise, a simple registry, message passing, and HTTP interaction.","keywords":["Rust Actor framework","Tokio mpsc","supervisor","oneshot","registry","async Rust","message passing","concurrency model"],"articleBody":"At 10 p.m., only a few warm lights are still on in the coffee shop. I‚Äôm behind the bar, watching the new teammate tie on an apron.\n‚ÄúRemember,‚Äù I hand over a walkie-talkie, ‚Äúeveryone has their own inbox. When an order comes in, don‚Äôt shout to the whole shop‚Äîjust slip it into the right box. They‚Äôll make one drink at a time, and no one fights over the kettle. The shop stays calm.‚Äù\nHe nods. I point to the duty roster on the wall: ‚ÄúWhat if someone drops off? Simple. We have a supervisor on duty. If someone goes down, the supervisor brings them back up or swaps in a fresh hire. Everyone‚Äôs name is in the front desk directory. If you need someone, call them by name.‚Äù\n‚ÄúDoesn‚Äôt sound complicated,‚Äù he smiles.\n‚ÄúRight.‚Äù I slide over the checklist. ‚ÄúIn Rust, this is the Actor model. Don‚Äôt think of concurrency as a group chat. It‚Äôs more like a small, orderly shop: messages are orders, Actors are baristas, addresses are walkie-talkies, supervision is the manager, and the directory is the registry. Let‚Äôs open for business.‚Äù\nLet‚Äôs set up this small shop. The code is short; the path is clear.\n1) Define Actor: set the rules for the barista #[async_trait::async_trait] pub trait Actor: Send + 'static { type Message: Send + 'static; async fn handle(\u0026mut self, msg: Self::Message); } The rules are really just two: what kind of order you take (Message), and when an order arrives, don‚Äôt fuss‚Äîtake it and process it yourself (handle). The one who takes the order decides its fate.\n2) Address Addr: give the barista a walkie-talkie I put the walkie-talkie in his hand and say: ‚ÄúWhen the red light blinks, press and speak. The order flies into the other person‚Äôs box. No chasing, no yelling to the entire shop.‚Äù In code, this walkie-talkie is an mpsc sending channel, a.k.a. Addr.\nuse tokio::sync::mpsc; #[derive(Clone)] pub struct Addr\u003cT\u003e { sender: mpsc::Sender\u003cT\u003e, } impl\u003cT\u003e Addr\u003cT\u003e { pub async fn send(\u0026self, msg: T) -\u003e Result\u003c(), mpsc::error::SendError\u003cT\u003e\u003e { self.sender.send(msg).await } } 3) spawn_actor: clock the barista in He clocks in, ties the apron, and stands at his station. There‚Äôs a click in the inbox‚Äîan order comes in; he processes it. No orders? He waits quietly for the next one. That‚Äôs ‚Äúbeing on shift.‚Äù\nuse tokio::sync::mpsc; use tokio::task::JoinHandle; pub fn spawn_actor\u003cA\u003e(mut actor: A, capacity: usize) -\u003e (Addr\u003cA::Message\u003e, JoinHandle\u003c()\u003e) where A: Actor, { let (tx, mut rx) = mpsc::channel::\u003cA::Message\u003e(capacity); let handle = tokio::spawn(async move { while let Some(msg) = rx.recv().await { actor.handle(msg).await; } }); (Addr { sender: tx }, handle) } If the inbox is full, send will wait. That‚Äôs natural throttling‚Äîlike a line at the counter. 4) supervise_actor: the manager keeps watch The supervisor is the last to leave. They don‚Äôt talk much, just watch two things: is the person still up, and is the shop still running? If someone suddenly collapses, the supervisor lets the shop breathe, brings the person back up, or starts a new shift. Steady is their only style.\nuse std::time::Duration; pub fn supervise_actor\u003cA, F\u003e(make: F, capacity: usize) -\u003e Addr\u003cA::Message\u003e where A: Actor, F: Fn() -\u003e A + Send + Sync + 'static, { let (addr_tx, addr_rx) = std::sync::mpsc::sync_channel::\u003cAddr\u003cA::Message\u003e\u003e(1); std::thread::spawn(move || { let rt = tokio::runtime::Runtime::new().expect(\"rt\"); rt.block_on(async move { loop { let (addr, handle) = spawn_actor(make(), capacity); let _ = addr_tx.send(addr.clone()); // Wait for actor to finish (normal or crash) let _ = handle.await; // Take a breath, then bring someone back on shift (continuous supervision) tokio::time::sleep(Duration::from_millis(200)).await; } }); }); // First available address addr_rx.recv().expect(\"supervisor failed to start\") } In production, you‚Äôd run supervision in the same Tokio runtime, with backoff, caps, and alerts‚Äîlike an old shop‚Äôs SOP, every piece in place.\n5) Named registry: the front desk directory There‚Äôs a notebook in the front drawer with everyone‚Äôs name and walkie-talkie channel. You don‚Äôt have to remember numbers‚Äîjust call by name and your message gets delivered. The registry is that notebook.\nuse once_cell::sync::Lazy; use std::any::Any; use std::collections::HashMap; use std::sync::{Arc, Mutex}; static REGISTRY: Lazy\u003cArc\u003cMutex\u003cHashMap\u003cString, Box\u003cdyn Any + Send + Sync\u003e\u003e\u003e\u003e\u003e = Lazy::new(|| { Arc::new(Mutex::new(HashMap::new())) }); pub fn register_addr\u003cT: 'static + Send + Sync\u003e(name: \u0026str, addr: Addr\u003cT\u003e) { let mut map = REGISTRY.lock().unwrap(); map.insert(name.to_string(), Box::new(addr)); } pub fn get_addr\u003cT: 'static + Send + Sync\u003e(name: \u0026str) -\u003e Option\u003cAddr\u003cT\u003e\u003e { let map = REGISTRY.lock().unwrap(); map.get(name) .and_then(|b| b.downcast_ref::\u003cAddr\u003cT\u003e\u003e()) .cloned() } Note: The above is for demonstration. In a real project, prefer dashmap with type-safe wrappers, or manage addresses centrally at the app layer to avoid cross-type erasure.\n6) Example: make a ‚Äúcounting coffee‚Äù On the first night shift, there aren‚Äôt many customers. I let him play a small game: for every drink made, increment a number; when someone asks how many, report it. Two message styles are enough for practice: Inc(n) means ‚Äúadd n more,‚Äù and Get means ‚Äúwhat‚Äôs the number now?‚Äù\nuse tokio::sync::oneshot; enum CounterMsg { Inc(u64), Get(oneshot::Sender\u003cu64\u003e), } struct Counter { value: u64 } #[async_trait::async_trait] impl Actor for Counter { type Message = CounterMsg; async fn handle(\u0026mut self, msg: Self::Message) { match msg { CounterMsg::Inc(n) =\u003e self.value += n, CounterMsg::Get(tx) =\u003e { let _ = tx.send(self.value); } } } } #[tokio::main] async fn main() { let (addr, _h) = spawn_actor(Counter { value: 0 }, 64); addr.send(CounterMsg::Inc(3)).await.unwrap(); addr.send(CounterMsg::Inc(7)).await.unwrap(); let (tx, rx) = oneshot::channel(); addr.send(CounterMsg::Get(tx)).await.unwrap(); let v = rx.await.unwrap(); println!(\"counter = {}\", v); // 10 } See? Two ‚Äúadd another cup,‚Äù one ‚Äúreport the number.‚Äù No complaints and no race for work‚Äîeverything in order, like a clock.\n7) Extensions (pick as needed) As the shop gets busier, you‚Äôll naturally add tools: a small HTTP takeout window at the front (hold an Addr in your axum/warp handler and dispatch to the back), a conveyor belt in the back (mpsc/broadcast/Stream to move half-finished items forward), a splitter and a worker pool as the team grows, SOP upgrades for the supervisor (backoff, tiers, limits), and dashboards with tracing for latency, queue depth, and error rates so you can sleep soundly.\nFAQ Q: Can I just await a return value? A: You can, but a more idiomatic way is to include a one-shot reply envelope (oneshot). When the work is done, they put the result back.\nQ: Will messages get lost? A: Queues have capacity. When they‚Äôre full, you‚Äôll wait a bit (backpressure). With good capacity and pacing, the line stays orderly and messages stay safe.\nQ: How‚Äôs performance? A: More than enough for most business workloads. If you‚Äôre chasing extremes, use lock-free structures, a dedicated executor, and locality optimizations.\nWrap-up That‚Äôs our little shop: roles are clear, routes are clear, busy but not chaotic. The nouns you see‚ÄîActor, Addr, spawn, supervise, registry‚Äîare just ways to encode this order. Don‚Äôt rush for features. First make ‚Äúmessage-driven, serial handling, and supervisable‚Äù solid. When the line gets long someday, you‚Äôll find this old discipline is your confidence to scale.\nFor a more systematic deep dive, see the long-form English article ‚ÄúYour Own Mini Actor Framework ‚Äî Build It From Scratch‚Äù (WeDev).\nFollow Mengshou Programming for more engineering deep-dives.\n","wordCount":"1159","inLanguage":"en","image":"https://rexai.top/en/tutorials/rust/mini-actor-framework-rust/cover.png","datePublished":"2025-08-21T00:00:00+08:00","dateModified":"2025-08-21T00:00:00+08:00","author":{"@type":"Person","name":"Rexai Programming"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://rexai.top/en/tutorials/rust/mini-actor-framework-rust/"},"publisher":{"@type":"Organization","name":"Ê¢¶ÂÖΩÁºñÁ®ã","logo":{"@type":"ImageObject","url":"https://rexai.top/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://rexai.top/en/ accesskey=h title="Ê¢¶ÂÖΩÁºñÁ®ã (Alt + H)">Ê¢¶ÂÖΩÁºñÁ®ã</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://rexai.top/ title=‰∏≠Êñá aria-label=‰∏≠Êñá>Zh-Cn</a></li></ul></div></div><button class=menu-toggle id=menu-toggle aria-label=ÊâìÂºÄËèúÂçï aria-controls=menu aria-expanded=false>
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><ul id=menu role=menubar><li role=none><a href=https://rexai.top/en/ title=Home role=menuitem><span>Home</span></a></li><li class=has-submenu role=none><a href=https://rexai.top/en/tutorials/ title="üìö Tutorials" role=menuitem><span>üìö Tutorials</span>
<span class=submenu-toggle role=button tabindex=0 aria-expanded=false aria-haspopup=true>‚ñº</span></a><ul class=submenu role=menu><li role=none><a href=https://rexai.top/en/tutorials/rust/ title=Rust role=menuitem>Rust</a></li><li role=none><a href=https://rexai.top/en/tutorials/ai/ title="AI Programming" role=menuitem>AI Programming</a></li></ul></li><li role=none><a href=https://rexai.top/en/tools/ title=Tools role=menuitem><span>Tools</span></a></li><li role=none><a href=https://rexai.top/en/news/ title="üî• News" role=menuitem><span>üî• News</span></a></li><li role=none><a href=https://rexai.top/en/tags/ title="üè∑Ô∏è Tags" role=menuitem><span>üè∑Ô∏è Tags</span></a></li><li role=none><a href=https://rexai.top/en/categories/ title="üìÇ Categories" role=menuitem><span>üìÇ Categories</span></a></li></ul><div id=menu-overlay class=menu-overlay hidden></div></nav></header><style>.has-submenu{position:relative}#menu{overflow:visible !important}#menu li{overflow:visible}.submenu{position:absolute;top:100%;left:0;background:var(--theme);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);min-width:180px;z-index:1000;list-style:none;display:none;padding:.5rem 0}.submenu li{display:block;margin:0;line-height:1.5}#menu .submenu li+li{margin-inline-start:0}.submenu a{display:block;padding:.75rem 1rem;color:var(--secondary);text-decoration:none;transition:all .2s ease;border-radius:0}.submenu a:hover{background:var(--entry);color:var(--primary)}.has-submenu:hover .submenu{display:block !important}.submenu-toggle{margin-left:.25rem;font-size:.75rem;transition:transform .2s ease;display:inline-block}.has-submenu:hover .submenu-toggle{transform:rotate(180deg)}@media(max-width:768px){.menu-toggle{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;margin-inline-end:var(--gap);border-radius:8px;border:1px solid var(--border);background:var(--theme);color:var(--primary)}#menu{position:fixed;top:0;right:0;height:100vh;width:82vw;max-width:340px;background:var(--theme);box-shadow:-2px 0 20px rgba(0,0,0,.18);transform:translateX(100%);transition:transform .25s ease;padding:calc(var(--header-height) + 10px)16px 20px;flex-direction:column;gap:4px;overflow-y:auto !important;z-index:1001}body.menu-open #menu{transform:translateX(0)}.menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:1000}body.menu-open .menu-overlay{opacity:1;pointer-events:auto}#menu li+li{margin-inline-start:0}#menu a{padding:12px 8px}.submenu{position:static;box-shadow:none;border:none;background:var(--entry);margin-top:0;margin-left:1rem;display:block;max-height:0;overflow:hidden;padding:0;transition:max-height .25s ease,padding .2s ease}.has-submenu.active .submenu{max-height:1000px;padding:4px 0 6px}.submenu-toggle{cursor:pointer}.has-submenu.active>a .submenu-toggle{transform:rotate(180deg)}}@media(min-width:769px){.menu-toggle{display:none}}.submenu a:focus-visible,#menu a:focus-visible,.menu-toggle:focus-visible,.submenu-toggle:focus-visible{outline:2px solid var(--primary);outline-offset:2px;border-radius:6px}@media(max-width:768px){#menu a.is-current,#menu a.is-current>span{border-bottom:none !important;background:var(--entry);color:var(--primary);border-radius:8px;font-weight:600}#menu a.is-current{padding:10px}#menu a{width:100%;border-radius:8px}#menu .active{border-bottom:none !important}}body.menu-open{overflow:hidden;touch-action:none}</style><script>(function(){const s=document.getElementById("menu"),t=document.getElementById("menu-toggle"),o=document.getElementById("menu-overlay");if(!s||!t||!o)return;const i=()=>window.innerWidth<=768,r=()=>{document.body.classList.add("menu-open"),t.setAttribute("aria-expanded","true"),o.hidden=!1,l()},n=()=>{document.body.classList.remove("menu-open"),t.setAttribute("aria-expanded","false"),o.hidden=!0,d(),t.focus()};t.addEventListener("click",()=>{const e=document.body.classList.contains("menu-open");e?n():r()}),o.addEventListener("click",n),window.addEventListener("keydown",e=>{e.key==="Escape"&&n()}),window.addEventListener("resize",()=>{window.innerWidth>768&&n()});const c=()=>{const e=Array.from(document.querySelectorAll(".has-submenu")),t=t=>{e.forEach(e=>{if(e!==t&&e.classList.contains("active")){e.classList.remove("active");const t=e.querySelector(".submenu-toggle");t&&t.setAttribute("aria-expanded","false")}})};e.forEach(e=>{const o=e.querySelector("a"),n=e.querySelector(".submenu-toggle"),a=e.querySelector(".submenu");if(!n||!a||!o)return;const r=t=>{n.setAttribute("aria-expanded",t?"true":"false"),e.classList.toggle("active",t)},s=()=>{const n=!e.classList.contains("active");n&&t(e),r(n)};n.addEventListener("click",e=>{if(!i())return;e.preventDefault(),e.stopPropagation(),s()}),n.addEventListener("keydown",e=>{if(!i())return;(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),e.stopPropagation(),s())}),o.addEventListener("click",e=>{if(!i())return;e.preventDefault(),e.stopPropagation(),s()})})};let e=[];const a=t=>{if(t.key!=="Tab"||!document.body.classList.contains("menu-open"))return;e=Array.from(s.querySelectorAll('a, button, [tabindex="0"]'));const n=e[0],o=e[e.length-1];if(!n||!o)return;t.shiftKey&&document.activeElement===n?(t.preventDefault(),o.focus()):!t.shiftKey&&document.activeElement===o&&(t.preventDefault(),n.focus())},l=()=>{e=Array.from(s.querySelectorAll('a, button, [tabindex="0"]')),e.length&&e[0].focus(),document.addEventListener("keydown",a)},d=()=>{document.removeEventListener("keydown",a)};c(),s.addEventListener("click",e=>{const t=e.target;if(!(t instanceof Element)||!i())return;const s=t.closest("a");if(!s)return;const o=s.closest("li"),a=o&&o.classList.contains("has-submenu");a||n()})})()</script><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Build Your Own Mini Actor Framework: Run Concurrency Like a Coffee Shop</h1><div class=post-description>A hands-on guide to building a usable mini Actor framework in Rust from scratch: Actor, Addr, spawn, supervise, a simple registry, message passing, and HTTP interaction.</div><div class=post-meta><span title='2025-08-21 00:00:00 +0800 +0800'>August 21, 2025</span>&nbsp;¬∑&nbsp;6 min&nbsp;¬∑&nbsp;1159 words&nbsp;¬∑&nbsp;Rexai Programming&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://rexai.top/tutorials/rust/mini-actor-framework-rust/>Zh-Cn</a></li></ul></div></header><figure class=entry-cover><img loading=eager srcset='https://rexai.top/tutorials/rust/mini-actor-framework-rust/cover_hu_96f4fbca55437ba6.png 360w,https://rexai.top/tutorials/rust/mini-actor-framework-rust/cover_hu_7c6670d72d2868f5.png 480w,https://rexai.top/tutorials/rust/mini-actor-framework-rust/cover_hu_af9d9472ee35ad7d.png 720w,https://rexai.top/tutorials/rust/mini-actor-framework-rust/cover_hu_249719dfdb8ed9f0.png 1080w,https://rexai.top/tutorials/rust/mini-actor-framework-rust/cover_hu_8dd7893d99585476.png 1500w,https://rexai.top/tutorials/rust/mini-actor-framework-rust/cover.png 1536w' src=https://rexai.top/tutorials/rust/mini-actor-framework-rust/cover.png sizes="(min-width: 768px) 720px, 100vw" width=1536 height=1024 alt="Mini Actor framework visualized in a night coffee shop: Actor, Addr, Inbox, Supervisor"><figcaption>Run concurrency like a coffee shop</figcaption></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-define-actor-set-the-rules-for-the-barista aria-label="1) Define Actor: set the rules for the barista">1) Define Actor: set the rules for the barista</a></li><li><a href=#2-address-addrt-give-the-barista-a-walkie-talkie aria-label="2) Address Addr<T>: give the barista a walkie-talkie">2) Address Addr&lt;T>: give the barista a walkie-talkie</a></li><li><a href=#3-spawn_actor-clock-the-barista-in aria-label="3) spawn_actor: clock the barista in">3) spawn_actor: clock the barista in</a></li><li><a href=#4-supervise_actor-the-manager-keeps-watch aria-label="4) supervise_actor: the manager keeps watch">4) supervise_actor: the manager keeps watch</a></li><li><a href=#5-named-registry-the-front-desk-directory aria-label="5) Named registry: the front desk directory">5) Named registry: the front desk directory</a></li><li><a href=#6-example-make-a-counting-coffee aria-label="6) Example: make a ‚Äúcounting coffee‚Äù">6) Example: make a ‚Äúcounting coffee‚Äù</a></li><li><a href=#7-extensions-pick-as-needed aria-label="7) Extensions (pick as needed)">7) Extensions (pick as needed)</a></li><li><a href=#faq aria-label=FAQ>FAQ</a></li><li><a href=#wrap-up aria-label=Wrap-up>Wrap-up</a></li></ul></div></details></div><div class=post-content><p>At 10 p.m., only a few warm lights are still on in the coffee shop. I‚Äôm behind the bar, watching the new teammate tie on an apron.</p><p>‚ÄúRemember,‚Äù I hand over a walkie-talkie, ‚Äúeveryone has their own inbox. When an order comes in, don‚Äôt shout to the whole shop‚Äîjust slip it into the right box. They‚Äôll make one drink at a time, and no one fights over the kettle. The shop stays calm.‚Äù</p><p>He nods. I point to the duty roster on the wall: ‚ÄúWhat if someone drops off? Simple. We have a supervisor on duty. If someone goes down, the supervisor brings them back up or swaps in a fresh hire. Everyone‚Äôs name is in the front desk directory. If you need someone, call them by name.‚Äù</p><p>‚ÄúDoesn‚Äôt sound complicated,‚Äù he smiles.</p><p>‚ÄúRight.‚Äù I slide over the checklist. ‚ÄúIn Rust, this is the Actor model. Don‚Äôt think of concurrency as a group chat. It‚Äôs more like a small, orderly shop: messages are orders, Actors are baristas, addresses are walkie-talkies, supervision is the manager, and the directory is the registry. Let‚Äôs open for business.‚Äù</p><p>Let‚Äôs set up this small shop. The code is short; the path is clear.</p><h2 id=1-define-actor-set-the-rules-for-the-barista>1) Define Actor: set the rules for the barista<a hidden class=anchor aria-hidden=true href=#1-define-actor-set-the-rules-for-the-barista>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[async_trait::async_trait]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>trait</span> Actor: Send <span style=color:#f92672>+</span> &#39;static {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Message</span>: Send <span style=color:#f92672>+</span> &#39;static;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, msg: <span style=color:#a6e22e>Self</span>::Message);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The rules are really just two: what kind of order you take (<code>Message</code>), and when an order arrives, don‚Äôt fuss‚Äîtake it and process it yourself (<code>handle</code>). The one who takes the order decides its fate.</p><h2 id=2-address-addrt-give-the-barista-a-walkie-talkie>2) Address <code>Addr&lt;T></code>: give the barista a walkie-talkie<a hidden class=anchor aria-hidden=true href=#2-address-addrt-give-the-barista-a-walkie-talkie>#</a></h2><p>I put the walkie-talkie in his hand and say: ‚ÄúWhen the red light blinks, press and speak. The order flies into the other person‚Äôs box. No chasing, no yelling to the entire shop.‚Äù In code, this walkie-talkie is an <code>mpsc</code> sending channel, a.k.a. <code>Addr&lt;T></code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::sync::mpsc;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[derive(Clone)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Addr</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    sender: <span style=color:#a6e22e>mpsc</span>::Sender<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Addr<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>send</span>(<span style=color:#f92672>&amp;</span>self, msg: <span style=color:#a6e22e>T</span>) -&gt; Result<span style=color:#f92672>&lt;</span>(), mpsc::error::SendError<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>        self.sender.send(msg).<span style=color:#66d9ef>await</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=3-spawn_actor-clock-the-barista-in>3) <code>spawn_actor</code>: clock the barista in<a hidden class=anchor aria-hidden=true href=#3-spawn_actor-clock-the-barista-in>#</a></h2><p>He clocks in, ties the apron, and stands at his station. There‚Äôs a click in the inbox‚Äîan order comes in; he processes it. No orders? He waits quietly for the next one. That‚Äôs ‚Äúbeing on shift.‚Äù</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::sync::mpsc;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::task::JoinHandle;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>spawn_actor</span><span style=color:#f92672>&lt;</span>A<span style=color:#f92672>&gt;</span>(<span style=color:#66d9ef>mut</span> actor: <span style=color:#a6e22e>A</span>, capacity: <span style=color:#66d9ef>usize</span>) -&gt; (Addr<span style=color:#f92672>&lt;</span>A::Message<span style=color:#f92672>&gt;</span>, JoinHandle<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>    A: <span style=color:#a6e22e>Actor</span>,
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (tx, <span style=color:#66d9ef>mut</span> rx) <span style=color:#f92672>=</span> mpsc::channel::<span style=color:#f92672>&lt;</span>A::Message<span style=color:#f92672>&gt;</span>(capacity);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> handle <span style=color:#f92672>=</span> tokio::spawn(<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>move</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>let</span> Some(msg) <span style=color:#f92672>=</span> rx.recv().<span style=color:#66d9ef>await</span> {
</span></span><span style=display:flex><span>            actor.handle(msg).<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    (Addr { sender: <span style=color:#a6e22e>tx</span> }, handle)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>If the inbox is full, <code>send</code> will wait. That‚Äôs natural throttling‚Äîlike a line at the counter.</li></ul><h2 id=4-supervise_actor-the-manager-keeps-watch>4) <code>supervise_actor</code>: the manager keeps watch<a hidden class=anchor aria-hidden=true href=#4-supervise_actor-the-manager-keeps-watch>#</a></h2><p>The supervisor is the last to leave. They don‚Äôt talk much, just watch two things: is the person still up, and is the shop still running? If someone suddenly collapses, the supervisor lets the shop breathe, brings the person back up, or starts a new shift. Steady is their only style.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> std::time::Duration;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>supervise_actor</span><span style=color:#f92672>&lt;</span>A, F<span style=color:#f92672>&gt;</span>(make: <span style=color:#a6e22e>F</span>, capacity: <span style=color:#66d9ef>usize</span>) -&gt; <span style=color:#a6e22e>Addr</span><span style=color:#f92672>&lt;</span>A::Message<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>    A: <span style=color:#a6e22e>Actor</span>,
</span></span><span style=display:flex><span>    F: Fn() -&gt; <span style=color:#a6e22e>A</span> <span style=color:#f92672>+</span> Send <span style=color:#f92672>+</span> Sync <span style=color:#f92672>+</span> &#39;static,
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (addr_tx, addr_rx) <span style=color:#f92672>=</span> std::sync::mpsc::sync_channel::<span style=color:#f92672>&lt;</span>Addr<span style=color:#f92672>&lt;</span>A::Message<span style=color:#f92672>&gt;&gt;</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    std::thread::spawn(<span style=color:#66d9ef>move</span> <span style=color:#f92672>||</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> rt <span style=color:#f92672>=</span> tokio::runtime::Runtime::new().expect(<span style=color:#e6db74>&#34;rt&#34;</span>);
</span></span><span style=display:flex><span>        rt.block_on(<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>move</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> (addr, handle) <span style=color:#f92672>=</span> spawn_actor(make(), capacity);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> _ <span style=color:#f92672>=</span> addr_tx.send(addr.clone());
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Wait for actor to finish (normal or crash)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>let</span> _ <span style=color:#f92672>=</span> handle.<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Take a breath, then bring someone back on shift (continuous supervision)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                tokio::time::sleep(Duration::from_millis(<span style=color:#ae81ff>200</span>)).<span style=color:#66d9ef>await</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// First available address
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    addr_rx.recv().expect(<span style=color:#e6db74>&#34;supervisor failed to start&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In production, you‚Äôd run supervision in the same Tokio runtime, with backoff, caps, and alerts‚Äîlike an old shop‚Äôs SOP, every piece in place.</p><h2 id=5-named-registry-the-front-desk-directory>5) Named registry: the front desk directory<a hidden class=anchor aria-hidden=true href=#5-named-registry-the-front-desk-directory>#</a></h2><p>There‚Äôs a notebook in the front drawer with everyone‚Äôs name and walkie-talkie channel. You don‚Äôt have to remember numbers‚Äîjust call by name and your message gets delivered. The registry is that notebook.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> once_cell::sync::Lazy;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::any::Any;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::collections::HashMap;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> std::sync::{Arc, Mutex};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>REGISTRY</span>: <span style=color:#a6e22e>Lazy</span><span style=color:#f92672>&lt;</span>Arc<span style=color:#f92672>&lt;</span>Mutex<span style=color:#f92672>&lt;</span>HashMap<span style=color:#f92672>&lt;</span>String, Box<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>dyn</span> Any <span style=color:#f92672>+</span> Send <span style=color:#f92672>+</span> Sync<span style=color:#f92672>&gt;&gt;&gt;&gt;&gt;</span> <span style=color:#f92672>=</span> Lazy::new(<span style=color:#f92672>||</span> {
</span></span><span style=display:flex><span>    Arc::new(Mutex::new(HashMap::new()))
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>register_addr</span><span style=color:#f92672>&lt;</span>T: &#39;static <span style=color:#f92672>+</span> Send <span style=color:#f92672>+</span> Sync<span style=color:#f92672>&gt;</span>(name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>, addr: <span style=color:#a6e22e>Addr</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> map <span style=color:#f92672>=</span> <span style=color:#66d9ef>REGISTRY</span>.lock().unwrap();
</span></span><span style=display:flex><span>    map.insert(name.to_string(), Box::new(addr));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_addr</span><span style=color:#f92672>&lt;</span>T: &#39;static <span style=color:#f92672>+</span> Send <span style=color:#f92672>+</span> Sync<span style=color:#f92672>&gt;</span>(name: <span style=color:#66d9ef>&amp;</span><span style=color:#66d9ef>str</span>) -&gt; Option<span style=color:#f92672>&lt;</span>Addr<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> map <span style=color:#f92672>=</span> <span style=color:#66d9ef>REGISTRY</span>.lock().unwrap();
</span></span><span style=display:flex><span>    map.get(name)
</span></span><span style=display:flex><span>        .and_then(<span style=color:#f92672>|</span>b<span style=color:#f92672>|</span> b.downcast_ref::<span style=color:#f92672>&lt;</span>Addr<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;&gt;</span>())
</span></span><span style=display:flex><span>        .cloned()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note: The above is for demonstration. In a real project, prefer <code>dashmap</code> with type-safe wrappers, or manage addresses centrally at the app layer to avoid cross-type erasure.</p><h2 id=6-example-make-a-counting-coffee>6) Example: make a ‚Äúcounting coffee‚Äù<a hidden class=anchor aria-hidden=true href=#6-example-make-a-counting-coffee>#</a></h2><p>On the first night shift, there aren‚Äôt many customers. I let him play a small game: for every drink made, increment a number; when someone asks how many, report it. Two message styles are enough for practice: <code>Inc(n)</code> means ‚Äúadd n more,‚Äù and <code>Get</code> means ‚Äúwhat‚Äôs the number now?‚Äù</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> tokio::sync::oneshot;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>CounterMsg</span> {
</span></span><span style=display:flex><span>    Inc(<span style=color:#66d9ef>u64</span>),
</span></span><span style=display:flex><span>    Get(oneshot::Sender<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u64</span><span style=color:#f92672>&gt;</span>),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Counter</span> { value: <span style=color:#66d9ef>u64</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[async_trait::async_trait]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Actor <span style=color:#66d9ef>for</span> Counter {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Message</span> <span style=color:#f92672>=</span> CounterMsg;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>handle</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, msg: <span style=color:#a6e22e>Self</span>::Message) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> msg {
</span></span><span style=display:flex><span>            CounterMsg::Inc(n) <span style=color:#f92672>=&gt;</span> self.value <span style=color:#f92672>+=</span> n,
</span></span><span style=display:flex><span>            CounterMsg::Get(tx) <span style=color:#f92672>=&gt;</span> { <span style=color:#66d9ef>let</span> _ <span style=color:#f92672>=</span> tx.send(self.value); }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (addr, _h) <span style=color:#f92672>=</span> spawn_actor(Counter { value: <span style=color:#ae81ff>0</span> }, <span style=color:#ae81ff>64</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    addr.send(CounterMsg::Inc(<span style=color:#ae81ff>3</span>)).<span style=color:#66d9ef>await</span>.unwrap();
</span></span><span style=display:flex><span>    addr.send(CounterMsg::Inc(<span style=color:#ae81ff>7</span>)).<span style=color:#66d9ef>await</span>.unwrap();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> (tx, rx) <span style=color:#f92672>=</span> oneshot::channel();
</span></span><span style=display:flex><span>    addr.send(CounterMsg::Get(tx)).<span style=color:#66d9ef>await</span>.unwrap();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> v <span style=color:#f92672>=</span> rx.<span style=color:#66d9ef>await</span>.unwrap();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>println!</span>(<span style=color:#e6db74>&#34;counter = </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, v); <span style=color:#75715e>// 10
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>See? Two ‚Äúadd another cup,‚Äù one ‚Äúreport the number.‚Äù No complaints and no race for work‚Äîeverything in order, like a clock.</p><h2 id=7-extensions-pick-as-needed>7) Extensions (pick as needed)<a hidden class=anchor aria-hidden=true href=#7-extensions-pick-as-needed>#</a></h2><p>As the shop gets busier, you‚Äôll naturally add tools: a small HTTP takeout window at the front (hold an <code>Addr&lt;T></code> in your <code>axum</code>/<code>warp</code> handler and dispatch to the back), a conveyor belt in the back (<code>mpsc</code>/<code>broadcast</code>/<code>Stream</code> to move half-finished items forward), a splitter and a worker pool as the team grows, SOP upgrades for the supervisor (backoff, tiers, limits), and dashboards with <code>tracing</code> for latency, queue depth, and error rates so you can sleep soundly.</p><h2 id=faq>FAQ<a hidden class=anchor aria-hidden=true href=#faq>#</a></h2><p>Q: Can I just <code>await</code> a return value?
A: You can, but a more idiomatic way is to include a one-shot reply envelope (<code>oneshot</code>). When the work is done, they put the result back.</p><p>Q: Will messages get lost?
A: Queues have capacity. When they‚Äôre full, you‚Äôll wait a bit (backpressure). With good capacity and pacing, the line stays orderly and messages stay safe.</p><p>Q: How‚Äôs performance?
A: More than enough for most business workloads. If you‚Äôre chasing extremes, use lock-free structures, a dedicated executor, and locality optimizations.</p><h2 id=wrap-up>Wrap-up<a hidden class=anchor aria-hidden=true href=#wrap-up>#</a></h2><p>That‚Äôs our little shop: roles are clear, routes are clear, busy but not chaotic. The nouns you see‚Äî<code>Actor</code>, <code>Addr</code>, <code>spawn</code>, <code>supervise</code>, registry‚Äîare just ways to encode this order. Don‚Äôt rush for features. First make ‚Äúmessage-driven, serial handling, and supervisable‚Äù solid. When the line gets long someday, you‚Äôll find this old discipline is your confidence to scale.</p><p>For a more systematic deep dive, see the long-form English article ‚ÄúYour Own Mini Actor Framework ‚Äî Build It From Scratch‚Äù (WeDev).</p><p>Follow Mengshou Programming for more engineering deep-dives.</p></div><section class=post-actions aria-label="post actions"><div class=post-actions__group><div class=post-actions__item><script type=text/javascript src=https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js data-name=bmc-button data-slug=winbbryz data-color=#FFDD00 data-emoji data-font=Cookie data-text="Buy me a coffee" data-outline-color=#000000 data-font-color=#000000 data-coffee-color=#ffffff></script></div></div></section><footer class=post-footer><ul class=post-tags><li><a href=https://rexai.top/en/tags/rust/>Rust</a></li><li><a href=https://rexai.top/en/tags/concurrency/>Concurrency</a></li><li><a href=https://rexai.top/en/tags/async/>Async</a></li><li><a href=https://rexai.top/en/tags/tokio/>Tokio</a></li><li><a href=https://rexai.top/en/tags/actor/>Actor</a></li></ul></footer></article></main><footer class=footer><span>¬© <a href=https://rexai.top/>Ê¢¶ÂÖΩÁºñÁ®ã</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>